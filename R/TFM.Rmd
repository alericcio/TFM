---
lang: es-ES
title: "TFM"
author: "Alessio Riccioli"
date: "10/9/2018"
output:
  html_document: 
    toc: yes
  word_document: default
---
```{r, message=FALSE, warning=FALSE, include=FALSE}
# install.packages("dplyr")
# install.packages("magrittr")

```

# Abstract

<div style="text-align: justify"> 
This study refers to an analysis, proposed by the Hospital Clínico San Carlos in Madrid, of the possibility of finding patterns of age, gender, and time period among patients admitted to the Emergency Department of the aforementioned hospital. For this work the following codes have been used: GRD, CDM and DCO that group and identify different types of diseases, transport, symptoms, intoxications, adverse effects of medications and any other reason why the patient should present at the consultation.
</div>

# Introducción

<div style="text-align: justify">
En el ambiente hospitalario, los códigos de diagnóstico se utilizan como una herramienta para agrupar e identificar enfermedades, trastornos, síntomas, envenenamientos, efectos adversos de drogas y productos químicos, lesiones y otras razones para el encuentro con el paciente. La codificación diagnóstica es la traducción de descripciones escritas de enfermedades, dolencias y lesiones en códigos de una clasificación particular. En la clasificación médica, los códigos de diagnóstico se utilizan como parte del proceso de codificación clínica junto con los códigos de intervención. Tanto los códigos de diagnóstico como los de intervención son asignados por un profesional de la salud capacitado en clasificación médica, como un codificador clínico o un administrador de información de salud. En este estudio se han utilizado sólo los códigos de diagnóstico.
Se han implementado varios sistemas de clasificación de diagnósticos con diversos grados de éxito en todo el mundo. Las diversas clasificaciones se centran en un tipo particular de encuentro con el paciente, como emergencia, hospitalización, consulta externa, salud mental y atención quirúrgica. La  International Statistical Classification of Diseases and Related Health Problems (ICD) es uno de los sistemas de clasificación más utilizados para la codificación de diagnósticos, ya que permite la comparabilidad y el uso de datos de mortalidad y morbilidad. De ahora en adelante nos referiremos a los ICD como DCO.

A medida que surgen los conocimientos sobre la salud y los avances médicos, los códigos de diagnóstico se revisan y actualizan para que coincidan con los conocimientos actuales más actualizados en el campo de la salud. Los códigos pueden revisarse con bastante frecuencia a medida que se adquieren nuevos conocimientos.

Los DCO son agrupados en GRD, o Grupos Relacionados por el Diagnóstico. Estos son una herramienta de gestión normalizadora,en la que mediante un programa informático, alimentado con los datos de los pacientes dados de alta hospitalaria el Conjunto Mínimo Básico de Datos (CMBD), podemos clasificar a los pacientes en grupos clínicamente similares y con parecido consumo de recursos sanitarios. CDM significa Categoría diagnóstica mayor.
Los GRD son un sistema de clasificación de pacientes por sistema de ajustes de riesgos con base en el isoconsumo de recursos. Sirven para conocer la casuística de un hospital, el case mix hospitalario. Son muy útiles en la gestión y financiación de hospitales. Los GRD son un sistema de clasificación que clasifica a los pacientes hospitalarios en grupos homogéneos en cuanto al consumo de recursos.

Los GRD finalmente vienen a sus veces agrupados mediante los 26 CDM, o Categoría Diagnóstica Mayor. Las CDM se suelen ajustar a los grandes aparatos o sistemas corporales. Son las 26 siguientes: 
</div>

* PreCDM (o CDM 0). Contiene una serie de GRD especiales.
* CDM 1. Enfermedades y trastornos del sistema nervioso.
* CDM 2. Enfermedades y trastornos del ojo.
* CDM 3. Enfermedades y trastornos del oído, nariz y boca.
* CDM 4. Enfermedades y trastornos del aparato respiratorio.
* CDM 5. Enfermedades y trastornos del aparato circulatorio.
* CDM 6. Enfermedades y trastornos del aparato digestivo.
* CDM 7. Enfermedades y trastornos del higado, sistema biliar y páncreas.
* CDM 8. Enfermedades y trastornos del sistema musculoesquelético y tejido conectivo.
* CDM 9. Enfermedades y trastornos de la piel, del tejido subcutáneo y de la mama.
* CDM 10. Enfermedades y trastornos endocrinos, nutricionales y metabólicos.
* CDM 11. Enfermedades y trastornos del riñón y vías urinarias.
* CDM 12. Enfermedades y trastornos del aparato reproductor masculino.
* CDM 13. Enfermedades y trastornos del aparato reproductor feminino.
* CDM 14. Embarazo, parto y puerperio.
* CDM 15. Recién nacidos y cuadros del periodo neonatal.
* CDM 16. Enfermedades y trastornos de sangre, sistema hematopoyético e inmunitario.
* CDM 17. Enfermedades y trastornos mieloproliferativos y neoplasias poco diferenciadas.
* CDM 18. Enfermedades infecciosas y parasitarias
* CDM 19. Enfermedades o trastornos mentales.
* CDM 20. Consumo alcohol/drogas y trastornos orgánicos mentales inducidos por drogas.
* CDM 21. Heridas, envenenamientos y efectos tóxicos de las drogas.
* CDM 22. Quemaduras.
* CDM 23. Factores que influyen en el estado de salud y otros contactos con servicios sanitarios.
* CDM 24. Infecciones por el Virus de la Inmunodeficiencia Humana.
* CDM 25. Politraumatismos importantes.

# Recopilación y preparación de datos

```{r include=TRUE}
rm(list=ls())
library(dplyr)
library(magrittr)
DCO = read.csv("DCO.csv", header = FALSE)
GRD = read.csv("GRD.csv", header = FALSE)
patologia = read.csv("patologia.csv", header = FALSE)
servicios = read.csv("Servicios.csv", header = FALSE)
colnames(DCO) <- c("id","DCO", "Description")
colnames(GRD) <- c("id","GRD", "Description")
colnames(patologia) <- c("id","N_historia", "Gender", "Edad", "Fec_Serv", "S_ingreso", "S_alta", "GRD", "Severidad", "Version_Grd", "Cdm", "Peso_Grd", "DCO")
colnames(servicios) <- c("id", "serv", "description")
dim(DCO)
dim(GRD)
dim(patologia)
dim(servicios)

# Join entre los dataframes para trabajar con una sola tabla.
primermerge <- merge(patologia, GRD, by = "GRD", all = TRUE)
segundomerge <- merge(primermerge, DCO, by = "DCO", all = TRUE)
patologia_limpio <- subset(segundomerge, select = -c(id.x, N_historia, S_ingreso, S_alta, Version_Grd, Peso_Grd, id.y, id))
colnames(patologia_limpio)[colnames(patologia_limpio)=="Description.x"] <- "Descripcion_GRD"
colnames(patologia_limpio)[colnames(patologia_limpio)=="Description.y"] <- "Descripcion_DCO"
patologia_limpio[, 'DCO'] <- as.factor(patologia_limpio[, 'DCO'])
patologia_limpio[, 'GRD'] <- as.factor(patologia_limpio[, 'GRD'])
patologia_limpio[, 'Fec_Serv'] <- as.Date(patologia_limpio[, 'Fec_Serv'])
patologia_limpio[, 'Severidad'] <- as.factor(patologia_limpio[, 'Severidad'])
patologia_limpio[, 'Descripcion_GRD'] <- as.character(patologia_limpio[, 'Descripcion_GRD'])
patologia_limpio[, 'Descripcion_DCO'] <- as.character(patologia_limpio[, 'Descripcion_DCO'])
patologia_limpio[, 'Descripcion_DCO'] <- as.character(patologia_limpio[, 'Descripcion_DCO'])
patologia_limpio[, 'Cdm'] <- as.factor(patologia_limpio[, 'Cdm'])

str(patologia_limpio)  # Tipo de variables
summary(patologia_limpio) # Resumen de las variables
```

Se han juntado las diferentes tablas en *patologia_limpio* para que el análisis resulte más claro.

# Análisis de Frecuencias de las enfermedades

```{r include=TRUE}

frecuencias <- as.data.frame(table(patologia_limpio[, 'GRD']))
colnames(frecuencias) <- c("GRD","Frecuencia")
hist(frecuencias[, 'Frecuencia'], xlim=c(0,1000), xlab = "Frecuencias", ylab = "Repeticiones")
table(frecuencias[, 'Frecuencia'] >= 200) # Saco sólo los GRD que se repiten más de 200 veces.
porcentaje <- (61*100)/(nrow(frecuencias))
porcentaje 

plot(frecuencias[, 'GRD'], frecuencias[, 'Frecuencia'], xlab ="GRD", ylab ="Frecuencia", main ="Grafico de frecuencias")

frecuentes <- frecuencias[ which(frecuencias[, 'Frecuencia'] >= 200), ]

(sum(frecuentes[, 'Frecuencia'])*100)/nrow(patologia_limpio)

# Ordeno y añado la frecuencia acumulada al dataframe frecuencias
frecuencias <- arrange(frecuencias, desc(Frecuencia)) %>%
        mutate(
                cumsum = cumsum(Frecuencia),
                freq = round(Frecuencia / sum(Frecuencia), 3),
                cum_freq = cumsum(freq)
               )

# Código para generar el gráfico de Pareto

# Guardo los parámetros 
def_par <- par() 

# Márgines
par(mar=c(5,5,4,5)) 

## Histograma, pc tendrá los valores del eje x
pc = barplot(frecuencias$Frecuencia,
             width = 1, space = 0.2, border = NA, axes = F,
             ylim = c(0, 1.05 * max(frecuencias$Frecuencia, na.rm = T)), 
             ylab = "Numero de pacientes" , cex.names = 0.7, 
             names.arg = frecuencias$GRD,
             main = "Grafico de Pareto")

## anotate left axis
axis(side = 2, at = c(0, frecuencias$Frecuencia), las = 1, col.axis = "grey62", col = "grey62", tick = T, cex.axis = 0.8)

## frame plot
box( col = "grey62")

## Líneas de las frecuencias acumuladas 
px <- frecuencias$cum_freq * max(frecuencias$Frecuencia, na.rm = T)
lines(pc, px, type = "b", cex = 0.7, pch = 19, col="cyan4")

## Annotate Right Axis
axis(side = 4, at = c(0, px), labels = paste(c(0, round(frecuencias$cum_freq * 100)) ,"%",sep=""), 
     las = 1, col.axis = "grey62", col = "cyan4", cex.axis = 0.8, col.axis = "cyan4")

## restoring default paramenter
#par(def_par) 

frecuentes <- frecuencias[1:81, ]
```
<div style="text-align: justify"> 
Se ha adoptado la técnica del 80/20 (Pareto), por el cual el 20% de los GRD refleja el 80% de los pacientes presentes en este estudio. Se ha creado el data.frame "frecuentes" en donde se almacenan los GRD que utilizaremos en este estudio.
</div>

```{r include=TRUE}
# agrupo todos los pacientes que han tenido los GRD más frecuentes, mostrando el DCO.

diag_frecuentes <- merge(frecuentes, patologia_limpio, by = "GRD", all = FALSE) 
dim(diag_frecuentes) # los pacientes analizados son 35285
head(diag_frecuentes)

```

Ciao questa è una prova.

